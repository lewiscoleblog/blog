<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Barnes-Hut Algorithm | Lewis Cole Blog</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Barnes-Hut Algorithm" />
<meta name="author" content="Lewis Cole (2020)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this blog post we will cover some of the basics of the Barnes Hut algorithm. This is completely new to me, it is not an algorithm I’ve used/studied before (and I am by no means an astrophysicist). Nonetheless it has piqued my interest so I have decided to write about it. In this blog I will be talking about 2 dimensions unless otherwise stated, this just makes the resulting code run a little quicker and output easier to visualise. Modifying the 2d code to be 3d (or even higher dimension) requires only minor revisions." />
<meta property="og:description" content="In this blog post we will cover some of the basics of the Barnes Hut algorithm. This is completely new to me, it is not an algorithm I’ve used/studied before (and I am by no means an astrophysicist). Nonetheless it has piqued my interest so I have decided to write about it. In this blog I will be talking about 2 dimensions unless otherwise stated, this just makes the resulting code run a little quicker and output easier to visualise. Modifying the 2d code to be 3d (or even higher dimension) requires only minor revisions." />
<link rel="canonical" href="https://www.lewiscoleblog.com/barnes-hut" />
<meta property="og:url" content="https://www.lewiscoleblog.com/barnes-hut" />
<meta property="og:site_name" content="Lewis Cole Blog" />
<meta property="og:image" content="https://github.com/lewiscoleblog/blog/raw/master/images/barnes-hut/Quadtree.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-02-18T00:00:00-06:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Lewis Cole (2020)"},"description":"In this blog post we will cover some of the basics of the Barnes Hut algorithm. This is completely new to me, it is not an algorithm I’ve used/studied before (and I am by no means an astrophysicist). Nonetheless it has piqued my interest so I have decided to write about it. In this blog I will be talking about 2 dimensions unless otherwise stated, this just makes the resulting code run a little quicker and output easier to visualise. Modifying the 2d code to be 3d (or even higher dimension) requires only minor revisions.","@type":"BlogPosting","headline":"Barnes-Hut Algorithm","dateModified":"2020-02-18T00:00:00-06:00","datePublished":"2020-02-18T00:00:00-06:00","image":"https://github.com/lewiscoleblog/blog/raw/master/images/barnes-hut/Quadtree.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lewiscoleblog.com/barnes-hut"},"url":"https://www.lewiscoleblog.com/barnes-hut","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://www.lewiscoleblog.com/feed.xml" title="Lewis Cole Blog" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Barnes-Hut Algorithm | Lewis Cole Blog</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Barnes-Hut Algorithm" />
<meta name="author" content="Lewis Cole (2020)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this blog post we will cover some of the basics of the Barnes Hut algorithm. This is completely new to me, it is not an algorithm I’ve used/studied before (and I am by no means an astrophysicist). Nonetheless it has piqued my interest so I have decided to write about it. In this blog I will be talking about 2 dimensions unless otherwise stated, this just makes the resulting code run a little quicker and output easier to visualise. Modifying the 2d code to be 3d (or even higher dimension) requires only minor revisions." />
<meta property="og:description" content="In this blog post we will cover some of the basics of the Barnes Hut algorithm. This is completely new to me, it is not an algorithm I’ve used/studied before (and I am by no means an astrophysicist). Nonetheless it has piqued my interest so I have decided to write about it. In this blog I will be talking about 2 dimensions unless otherwise stated, this just makes the resulting code run a little quicker and output easier to visualise. Modifying the 2d code to be 3d (or even higher dimension) requires only minor revisions." />
<link rel="canonical" href="https://www.lewiscoleblog.com/barnes-hut" />
<meta property="og:url" content="https://www.lewiscoleblog.com/barnes-hut" />
<meta property="og:site_name" content="Lewis Cole Blog" />
<meta property="og:image" content="https://github.com/lewiscoleblog/blog/raw/master/images/barnes-hut/Quadtree.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-02-18T00:00:00-06:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Lewis Cole (2020)"},"description":"In this blog post we will cover some of the basics of the Barnes Hut algorithm. This is completely new to me, it is not an algorithm I’ve used/studied before (and I am by no means an astrophysicist). Nonetheless it has piqued my interest so I have decided to write about it. In this blog I will be talking about 2 dimensions unless otherwise stated, this just makes the resulting code run a little quicker and output easier to visualise. Modifying the 2d code to be 3d (or even higher dimension) requires only minor revisions.","@type":"BlogPosting","headline":"Barnes-Hut Algorithm","dateModified":"2020-02-18T00:00:00-06:00","datePublished":"2020-02-18T00:00:00-06:00","image":"https://github.com/lewiscoleblog/blog/raw/master/images/barnes-hut/Quadtree.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lewiscoleblog.com/barnes-hut"},"url":"https://www.lewiscoleblog.com/barnes-hut","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://www.lewiscoleblog.com/feed.xml" title="Lewis Cole Blog" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Lewis Cole Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Barnes-Hut Algorithm</h1><p class="page-description">In this blog post we will cover some of the basics of the Barnes Hut algorithm. This is completely new to me, it is not an algorithm I&#39;ve used/studied before (and I am by no means an astrophysicist). Nonetheless it has piqued my interest so I have decided to write about it. In this blog I will be talking about 2 dimensions unless otherwise stated, this just makes the resulting code run a little quicker and output easier to visualise. Modifying the 2d code to be 3d (or even higher dimension) requires only minor revisions.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-02-18T00:00:00-06:00" itemprop="datePublished">
        Feb 18, 2020
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Lewis Cole (2020)</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      9 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#computation">computation</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#N-body">N-body</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#quadtree">quadtree</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#Barnes-Hut">Barnes-Hut</a>
        
      
      </p>
    

    
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#The-N-Body-Problem">The N-Body Problem </a></li>
<li class="toc-entry toc-h2"><a href="#Barnes-Hut-Process">Barnes Hut Process </a></li>
<li class="toc-entry toc-h2"><a href="#Implementation">Implementation </a></li>
<li class="toc-entry toc-h2"><a href="#Conclusion">Conclusion </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-02-18-Barnes-Hut.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-N-Body-Problem">
<a class="anchor" href="#The-N-Body-Problem" aria-hidden="true"><span class="octicon octicon-link"></span></a>The N-Body Problem<a class="anchor-link" href="#The-N-Body-Problem"> </a>
</h2>
<p>It is well understood that for $N &gt; 2$ that the problem of determining trajectories under gravitation for N-bodies cannot be solved analytically. Instead we must rely on computation to create trajectories. From Newton's equations we can write the force $\pmb{F_{i,j}}$ between two bodies $i, j$ with masses $m_i, m_j$ and positions $\pmb{p_i}, \pmb{p_j}$ as:

$$ \pmb{F_{i,j}} = \frac{G m_i m_j (\pmb{p_i} - \pmb{p_j})} {\lVert \pmb{p_i} - \pmb{p_j} \rVert^3} $$
</p>
<p>For $N$ bodies we therefore have $\frac{N(N-1)}{2}$ forces to be calculated. For small $N$ this is not a problem, however if we want to model galaxy dynamics with thousands (or more) of bodies this becomes a computational issue.</p>
<h2 id="Barnes-Hut-Process">
<a class="anchor" href="#Barnes-Hut-Process" aria-hidden="true"><span class="octicon octicon-link"></span></a>Barnes Hut Process<a class="anchor-link" href="#Barnes-Hut-Process"> </a>
</h2>
<p>With Barnes Hut we can move from $O(N^2)$ complexity to $O(Nln(N))$ - this is a significant improvement for large $N$.</p>
<p>The crux of the Barnes Hut scheme is to approximate the effect of "far away" bodies but calculate exactly the forces attributed to "near" bodies. To do this a quadtree data structure is used (in 3d an octree or higher dimensions a $2^d$tree). To do this the space is partitioned into 4 equal squares at depth 1 (or 8 cubes in 3d or $2^d$ hypercubes in higher dimension) - at depth 2 each of these squares is then partitioned into 4 equal squares and so on. From this a tree is constructed with each node representing the number of bodies within the quadrant at that depth. This is repeated recursively until a depth is reached where each quadrant has 1 or 0 bodies in it. It is easier to understand this with a visual example:</p>
<p><img src="https://github.com/lewiscoleblog/blog/raw/master/images/barnes-hut/Quadtree.png" alt="" title="Source: https://developer.apple.com/documentation/gameplaykit/gkquadtree"></p>
<p>With this data structure in place we can begin to simulate. For each quadrant in the quadtree we can calculate a centre of mass (in the obvious way). Then given a body we can calculate the force acting on it from a given quadrant by applying the Newtonian force calculation using the centre of mass. We could, for example, apply this to the 4 quadrants at depth 1 to approximate the force acting on the body. This of course might not be particularly accurate if there are many bodies present. To overcome this the Barnes Hut algorithm specifies a critical distance $\theta$ if the distance beween the body and the centre of mass of the quadrant is greater than $\theta$ then it is used as an approximation, if not the algorithm moves to the next depth of the quadtree and tries again, this happens recursively until the distance becomes below $\theta$ or there is only 1 body in the quadrant (as such setting $\theta = 0$ returns to the $O(N^2)$ brute force approach).</p>
<p>While this is presented as an algorithm for the N-body problem it can be used in other situations that involve a spatial dimension and many entities. I am currently considering an application to speed up an agent based model (potentially the subject of another blog post).</p>
<h2 id="Implementation">
<a class="anchor" href="#Implementation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Implementation<a class="anchor-link" href="#Implementation"> </a>
</h2>
<p>Initially I will code up an example in Python, I may revisit this and create a more efficient implementation in Cython/C++/etc. I will ignore all "complications" for example I will not give each body a size nor will it consider collisions, etc. Each body is a "point mass" in this example. For now I'll also ignore the issues relating to plotting trajectories.</p>
<p>We first create a node class to represent nodes within the quadtree. Using this data structure we will then apply a verlet time step to calculate positions:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">node</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    A class for a node within the quadtree.</span>
<span class="sd">    </span>
<span class="sd">    We use the terminology "child" for nodes in the next depth level - consistent with tree nomenclature</span>
<span class="sd">    If a node is "childless" then it represents a body</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Initializes a childless node</span>
<span class="sd">        </span>
<span class="sd">        m - Mass of node</span>
<span class="sd">        x - x-coordinate centre of mass</span>
<span class="sd">        y - y-coordinate centre of mass</span>
<span class="sd">        px - x- coordinate of momentum</span>
<span class="sd">        py - y-coordinate of momentum</span>
<span class="sd">        pos - centre of mass array</span>
<span class="sd">        mom - momentum array</span>
<span class="sd">        child - child node</span>
<span class="sd">        s - side-length (depth=0 s=1)</span>
<span class="sd">        relpos = relative position</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">next_quad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Places node in next quadrant and returns quadrant number</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide_quad</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">divide_quad</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">divide_quad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Places node in next level quadrant and recomputes relative position</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">2.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">quadrant</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">quadrant</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">quadrant</span>
    
    <span class="k">def</span> <span class="nf">reset_quad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Repositions to the zeroth depth quadrant (full space)</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        
    <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Calculates distance between node and another node</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">force_ap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Force applied from current node to other</span>
<span class="sd">        """</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">d</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    

<span class="k">def</span> <span class="nf">add_body</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Adds body to a node of quadtree. A minimum quadrant size is imposed</span>
<span class="sd">    to limit the recursion depth.</span>
<span class="sd">    """</span>
    <span class="n">new_node</span> <span class="o">=</span> <span class="n">body</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">min_quad_size</span> <span class="o">=</span> <span class="mf">1.e-5</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">min_quad_size</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">child</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">new_node</span><span class="o">.</span><span class="n">child</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
            <span class="n">quad</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">next_quad</span><span class="p">()</span>
            <span class="n">new_node</span><span class="o">.</span><span class="n">child</span><span class="p">[</span><span class="n">quad</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="n">node</span>

        <span class="n">new_node</span><span class="o">.</span><span class="n">m</span> <span class="o">+=</span> <span class="n">body</span><span class="o">.</span><span class="n">m</span>
        <span class="n">new_node</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">body</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">quad</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">next_quad</span><span class="p">()</span>
        <span class="n">new_node</span><span class="o">.</span><span class="n">child</span><span class="p">[</span><span class="n">quad</span><span class="p">]</span> <span class="o">=</span> <span class="n">add_body</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">new_node</span><span class="o">.</span><span class="n">child</span><span class="p">[</span><span class="n">quad</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">new_node</span>

<span class="k">def</span> <span class="nf">force_on</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">child</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">force_ap</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">node</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">*</span> <span class="n">theta</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">force_ap</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">force_on</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">child</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">verlet</span><span class="p">(</span><span class="n">bodies</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">:</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="n">force_on</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">body</span><span class="o">.</span><span class="n">mom</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">force</span>
        <span class="n">body</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">body</span><span class="o">.</span><span class="n">mom</span> <span class="o">/</span> <span class="n">body</span><span class="o">.</span><span class="n">m</span>

<span class="k">def</span> <span class="nf">model_step</span><span class="p">(</span><span class="n">bodies</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
    <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">:</span>
        <span class="n">body</span><span class="o">.</span><span class="n">reset_quad</span><span class="p">()</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">add_body</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
    <span class="n">verlet</span><span class="p">(</span><span class="n">bodies</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

<span class="c1">########## Main Code ##########</span>
<span class="c1"># Parameters</span>
<span class="n">Theta</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">G</span> <span class="o">=</span> <span class="mf">1.e-6</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1.e-2</span>
<span class="n">N_bodies</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">N_steps</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># Fix Seed for Initialization</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="c1"># Initial Conditions</span>
<span class="n">Masses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>
<span class="n">X0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span>
<span class="n">Y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span>
<span class="n">PX0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">PY0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>

<span class="c1"># Initialize</span>
<span class="n">Bodies</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">pX0</span><span class="p">,</span> <span class="n">pY0</span><span class="p">,</span> <span class="n">masses</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">pX0</span><span class="p">,</span> <span class="n">pY0</span><span class="p">,</span> <span class="n">masses</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X0</span><span class="p">,</span> <span class="n">Y0</span><span class="p">,</span> <span class="n">PX0</span><span class="p">,</span> <span class="n">PY0</span><span class="p">,</span> <span class="n">Masses</span><span class="p">)]</span>

<span class="c1"># Main Model Loop</span>
<span class="k">def</span> <span class="nf">Model_Loop_BH</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">model_step</span><span class="p">(</span><span class="n">Bodies</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

<span class="o">%</span><span class="k">timeit</span> Model_Loop_BH(N_steps)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>7.97 s ± 446 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This code is not the most efficient possible for this model (in all likelihood one would only use Barnes-Hut for large galaxy simulations and so it's unlikely that Python would be the best choice). For 100 bodies and 1000 time steps this code runs on my machine in around 8s.</p>
<p>We can also code up a "brute force" approach (calculating forces between all pairs of bodies) to compare, it is likely that the cost of computing the quadtree could be more costly than just computing all forces directly when the number of bodies is suitably small. We could run these codes multiple times to find where this is the case.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># from numba import njit</span>

<span class="n">G</span> <span class="o">=</span> <span class="mf">1.e-6</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1.e-2</span>
<span class="n">N_bodies</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">N_steps</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># Fix Seed for Initialization</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="c1"># Initial Conditions</span>
<span class="n">Masses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span>
<span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">PY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">))</span>
<span class="n">mom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span> <span class="n">PY</span><span class="p">))</span>

<span class="c1">#@njit</span>
<span class="k">def</span> <span class="nf">force_array</span><span class="p">(</span><span class="n">pos_arr</span><span class="p">,</span> <span class="n">m_array</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">pos_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">force_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="p">,</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">force_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="n">m_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]))</span><span class="o">**</span><span class="mi">3</span>
                <span class="n">force_arr</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">force_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">force_arr</span>

<span class="c1">#@njit</span>
<span class="k">def</span> <span class="nf">update_mom</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">mom_arr</span><span class="p">,</span> <span class="n">force_arr</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">mom_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">del_mom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mom_arr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">del_mom</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">force_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mom_arr</span> <span class="o">+</span> <span class="n">del_mom</span>

<span class="c1">#@njit</span>
<span class="k">def</span> <span class="nf">update_pos</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">pos_arr</span><span class="p">,</span> <span class="n">new_mom</span><span class="p">,</span> <span class="n">m_arr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pos_arr</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="n">new_mom</span> <span class="o">/</span> <span class="n">m_arr</span>

<span class="c1">#@njit</span>
<span class="k">def</span> <span class="nf">main_loop</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">pos_arr</span><span class="p">,</span> <span class="n">mom_arr</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>    
        <span class="n">force</span> <span class="o">=</span> <span class="n">force_array</span><span class="p">(</span><span class="n">pos_arr</span><span class="p">,</span> <span class="n">Masses</span><span class="p">)</span>
        <span class="n">mom_arr</span> <span class="o">=</span> <span class="n">update_mom</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">mom_arr</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
        <span class="n">pos_arr</span> <span class="o">=</span> <span class="n">update_pos</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">pos_arr</span><span class="p">,</span> <span class="n">mom_arr</span><span class="p">,</span> <span class="n">Masses</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pos_arr</span>

<span class="o">%</span><span class="k">timeit</span> main_loop(N_steps, pos, mom)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1min 18s ± 1.89 s per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This brute force code is not implemented in a particularly efficient way, however it is good enough for illustration purposes. Even for relatively small model sizes (100 bodies for 1000 time steps) the code takes considerably longer than the Barnes-Hut algorithm, with timeit giving an approximate timing of around 78s - about 10 times slower than the Barnes-Hut implementation.</p>
<p>If we use Numba with the njit decorator we can improve this to 3s - which while quicker is not considerably better than the Barnes-Hut algorithm. As the number of bodies increases (and perhaps some fine tuning of the Barnes-Hut parameters) we would expect even more drastic improvements.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>

<span class="n">G</span> <span class="o">=</span> <span class="mf">1.e-6</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1.e-2</span>
<span class="n">N_bodies</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">N_steps</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># Fix Seed for Initialization</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="c1"># Initial Conditions</span>
<span class="n">Masses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span>
<span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">PY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N_bodies</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">))</span>
<span class="n">mom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">PX</span><span class="p">,</span> <span class="n">PY</span><span class="p">))</span>

<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">force_array</span><span class="p">(</span><span class="n">pos_arr</span><span class="p">,</span> <span class="n">m_array</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">pos_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">force_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="p">,</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">force_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="n">m_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">pos</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]))</span><span class="o">**</span><span class="mi">3</span>
                <span class="n">force_arr</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">force_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">force_arr</span>

<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">update_mom</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">mom_arr</span><span class="p">,</span> <span class="n">force_arr</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">mom_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">del_mom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mom_arr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">del_mom</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">force_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mom_arr</span> <span class="o">+</span> <span class="n">del_mom</span>

<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">update_pos</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">pos_arr</span><span class="p">,</span> <span class="n">new_mom</span><span class="p">,</span> <span class="n">m_arr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pos_arr</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="n">new_mom</span> <span class="o">/</span> <span class="n">m_arr</span>

<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">main_loop</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">pos_arr</span><span class="p">,</span> <span class="n">mom_arr</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>    
        <span class="n">force</span> <span class="o">=</span> <span class="n">force_array</span><span class="p">(</span><span class="n">pos_arr</span><span class="p">,</span> <span class="n">Masses</span><span class="p">)</span>
        <span class="n">mom_arr</span> <span class="o">=</span> <span class="n">update_mom</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">mom_arr</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
        <span class="n">pos_arr</span> <span class="o">=</span> <span class="n">update_pos</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">pos_arr</span><span class="p">,</span> <span class="n">mom_arr</span><span class="p">,</span> <span class="n">Masses</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pos_arr</span>

<span class="o">%</span><span class="k">timeit</span> main_loop(N_steps, pos, mom)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>3 s ± 33.1 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">
<a class="anchor" href="#Conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion<a class="anchor-link" href="#Conclusion"> </a>
</h2>
<p>We have seen that even for relatively modest models the Barnes-Hut algorithm provides fairly efficient computation for the N-body problem. We would expect the improvement to be even more marked for larger models. However Python on its own is not the best place to implement this and a C++ implementation would offer better performance. With some work a Cython approach should be possible and offer performance improvements. The code would require some major re-working if Numba is to be used instead owing to the reliance on classes to generate the quadtree.</p>

</div>
</div>
</div>
</div>



  </div><a class="u-url" href="/barnes-hut" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>A blog about maths, probability, modelling and computing.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/lewiscoleblog" title="lewiscoleblog"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jazzcoffeestuff" title="jazzcoffeestuff"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
